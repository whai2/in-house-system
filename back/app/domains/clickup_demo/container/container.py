"""ClickUp Demo Dependency Injection Container"""

import os
from dependency_injector import containers, providers
from langchain_anthropic import ChatAnthropic
from langgraph.checkpoint.memory import MemorySaver

from app.domains.clickup_demo.services.agent.mcp_client import ClickUpMCPClient
from app.domains.clickup_demo.services.agent.agent import ClickUpAgent
from app.domains.clickup_demo.services.agent.langfuse_handler import LangFuseHandler
from app.domains.clickup_demo.repositories import SessionRepository, ChatRepository
from app.domains.clickup_demo.handlers import ChatHandler
from app.common.database.mongodb import get_database


class ClickUpDemoContainer(containers.DeclarativeContainer):
    """ClickUp Demo 의존성 주입 컨테이너"""

    # Configuration
    config = providers.Configuration()

    # Memory Saver (Singleton - 모든 대화에서 공유)
    memory_saver = providers.Singleton(MemorySaver)

    # LLM (Singleton - 재사용)
    llm = providers.Singleton(
        ChatAnthropic,
        model="claude-sonnet-4-20250514",  # Opus 4.5 대비 5배 저렴, 성능은 충분
        temperature=0.7,
        api_key=providers.Callable(lambda: os.environ.get("ANTHROPIC_API_KEY")),
        # 프롬프트 캐싱 활성화 (반복되는 긴 컨텍스트에 대해 90% 비용 절감)
        model_kwargs={"extra_headers": {"anthropic-beta": "prompt-caching-2024-07-31"}},
    )

    # ClickUp MCP Client (Singleton - MCP 서버 연결 공유)
    mcp_client = providers.Singleton(
        ClickUpMCPClient,
        clickup_token=providers.Callable(lambda: os.environ.get("CLICKUP_ACCESS_TOKEN")),
    )

    # LangFuse Handler (Singleton - 환경변수에서 자동으로 설정 로드)
    langfuse_handler = providers.Singleton(LangFuseHandler)

    # MongoDB Database (Callable - get_database() 함수 호출)
    database = providers.Callable(get_database)

    # Repositories (Factory - 요청마다 새 인스턴스)
    session_repository = providers.Factory(SessionRepository, db=database)

    chat_repository = providers.Factory(ChatRepository, db=database)

    # Handlers (Factory - 비즈니스 로직 처리)
    chat_handler = providers.Factory(
        ChatHandler,
        session_repository=session_repository,
        chat_repository=chat_repository,
    )

    # ClickUp Agent (Singleton - MCP 세션 및 도구 재사용, Handler 주입)
    clickup_agent = providers.Singleton(
        ClickUpAgent,
        llm=llm,
        mcp_client=mcp_client,
        memory_saver=memory_saver,
        chat_handler=chat_handler,
        langfuse_handler=langfuse_handler,
    )
